name: Build Application

on:
   push:
      tags:
         - 'v*'
   workflow_dispatch:

jobs:
   build:
      name: Build for ${{ matrix.os_name }}
      runs-on: ${{ matrix.os }}
      strategy:
         fail-fast: false
         matrix:
            include:
               - os: windows-latest
                 os_name: Windows
                 artifact_name: SlowlyLetterDownloader-Windows.zip
                 exe_name: SlowlyLetterDownloader.exe
               - os: macos-13
                 os_name: MacOS-Intel
                 artifact_name: SlowlyLetterDownloader-MacOS-Intel.zip
                 exe_name: SlowlyLetterDownloader.app
               - os: macos-14
                 os_name: MacOS-AppleSilicon
                 artifact_name: SlowlyLetterDownloader-MacOS-Silicon.zip
                 exe_name: SlowlyLetterDownloader.app
               - os: ubuntu-latest
                 os_name: Linux
                 artifact_name: SlowlyLetterDownloader-Linux.tar.gz
                 exe_name: SlowlyLetterDownloader

      steps:
         - uses: actions/checkout@v4

         - name: Set up Python
           uses: actions/setup-python@v4
           with:
              python-version: '3.10'

         - name: Install System Dependencies (Linux)
           if: runner.os == 'Linux'
           run: |
              sudo apt-get update
              sudo apt-get install -y python3-tk

         - name: Install Python Dependencies
           run: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
              playwright install

         - name: Build with build.py
           run: |
              python build.py

         # Zip/Tar the output to preserve permissions and folder structure
         - name: Compress Build (Windows)
           if: runner.os == 'Windows'
           run: |
              cd dist
              Compress-Archive -Path SlowlyLetterDownloader.exe -DestinationPath ..\${{ matrix.artifact_name }}

         - name: Compress Build (Unix)
           if: runner.os != 'Windows'
           run: |
              cd dist
              chmod +x SlowlyLetterDownloader
              tar -czf ../${{ matrix.artifact_name }} SlowlyLetterDownloader

         - name: Upload Artifact
           uses: actions/upload-artifact@v4
           with:
              name: ${{ matrix.os_name }}-Build
              path: ${{ matrix.artifact_name }}
